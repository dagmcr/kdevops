#!/bin/bash
#
# Result for 128 thread, 4 file, size 1G (filesize):
# du --bytes /mnt-tmpfs
# 549755813888
# du -sh /mnt-tmpfs
# 512G
#
# Result for 1 thread, 1 file, size 1GiB (filesize):
# du —bytes /mnt-tmpfs
# 999948288
# du -sh /mnt-tmpfs
# 954M
#
# Result for 1 thread, 1 file, size 1G (filesize):
# du —bytes /mnt-tmpfs
# 1073741824
# du -sh /mnt-tmpfs
# 1.0G

logfile=/tmp/log-$(uname --kernel-release)-{{ file }}

rm -rf $logfile

loop() {
bs=$1
{{ mount }}
echo "bs=$bs" | tee --append $logfile
fio \
	-name=four-1G-per-thread \
	--nrfiles=10 -bs=$bs -direct=1 \
	-ioengine=io_uring \
	--group_reporting=1 \
	--alloc-size=1048576 --filesize=1G \
	--readwrite=write --fallocate=none \
	--numjobs=$(nproc) --create_on_open=1 \
	--directory=/mnt-tmpfs | tee --append $logfile

sudo umount --verbose /mnt-tmpfs
}

loop 4k
loop 8k
loop 16k
loop 32k
loop 64k
loop 128k
loop 256k
loop 512k
loop 1M
loop 2M
